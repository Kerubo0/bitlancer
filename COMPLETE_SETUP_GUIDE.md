# IMPORTANT: Complete Setup Checklist

## Issue Summary

You're getting errors because:
1. âŒ **Profile trigger not set up** - Profiles aren't auto-created on signup
2. âŒ **Bitnob service was using wrong endpoints** - Now fixed
3. âŒ **No automatic wallet creation on login** - Now fixed

## âœ… What's Been Fixed

### 1. Bitnob Service (Fixed)
- Now uses correct 2-step process:
  - Step 1: Create customer (`POST /api/v1/customers`)
  - Step 2: Generate Bitcoin address (`POST /api/v1/addresses/generate`)
- Real Bitcoin addresses are **generated by Bitnob**, not you

### 2. Login Flow (Fixed)
- When user logs in, app now checks if wallet exists
- If no wallet found â†’ automatically creates one
- Wallet creation includes real Bitcoin address from Bitnob

### 3. Balance Fetching (Fixed)
- Changed to use `/api/v1/wallets` (company wallet)
- Returns your Bitcoin wallet balance

## ğŸ”´ CRITICAL: You MUST Do This Now

### Run the Profile Trigger SQL

**This is the most important step!** Without this, profiles won't be created automatically.

1. **Open Supabase Dashboard**: https://app.supabase.com
2. **Go to your BitLancer project**
3. **Click "SQL Editor" in left sidebar**
4. **Click "New Query"**
5. **Copy and paste this SQL**:

\`\`\`sql
-- Create function to automatically create profile on user signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', 'User')
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger on auth.users table
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Add INSERT policy for profiles (needed for the trigger)
DROP POLICY IF EXISTS "Enable insert for authenticated users only" ON public.profiles;
CREATE POLICY "Enable insert for authenticated users only"
  ON public.profiles FOR INSERT
  WITH CHECK (auth.uid() = id);
\`\`\`

6. **Click "RUN"** (bottom right)
7. **You should see**: "Success. No rows returned"

## ğŸ§ª Test the Complete Flow

### Option 1: New User Signup

1. **Clear any existing test users** from Supabase Auth dashboard (optional)
2. **Go to your app**: http://localhost:5173
3. **Sign up** with a NEW email address
4. **Watch the server console** - you should see:
   \`\`\`
   Step 1: Creating customer...
   âœ… Customer created: <customer-id>
   Step 2: Generating Bitcoin address...
   âœ… Bitcoin address generated!
   \`\`\`
5. **Check Supabase profiles table** - should see:
   - âœ… Profile created automatically (via trigger)
   - âœ… wallet_id populated (Bitnob customer ID)
   - âœ… onchain_address populated (real Bitcoin address)

### Option 2: Existing User Login

1. **Log in** with existing email/password
2. **App automatically checks** for wallet
3. **If no wallet** â†’ creates one automatically
4. **Dashboard loads** with Bitcoin address

## ğŸ“Š How to Verify It's Working

### In Browser Console:
- âœ… No 422 errors (signup works)
- âœ… No 400 errors (login works)
- âœ… No 500 errors (wallet created successfully)
- âœ… "Wallet created successfully" message

### In Server Console:
\`\`\`
ğŸ“ Creating Bitnob customer and generating Bitcoin address...
   Email: test@example.com
   Step 1: Creating customer...
   âœ… Customer created: a041d1c0-...
   Step 2: Generating Bitcoin address...
   âœ… Bitcoin address generated!
\`\`\`

### In Supabase Dashboard:
Go to **Table Editor â†’ profiles**:
- Column `wallet_id`: Should have Bitnob customer ID
- Column `onchain_address`: Should have real Bitcoin address (bc1q...)
- Column `lightning_address`: May be null (depends on Bitnob response)

## ğŸ› Troubleshooting

### Still getting 422 errors?
- **Cause**: User already exists with that email
- **Fix**: Use a different email OR delete user from Supabase Auth dashboard

### Still getting 400 errors on login?
- **Cause**: Wrong password or user doesn't exist
- **Fix**: Double-check credentials or sign up first

### Still getting 500 errors?
- **Cause**: Profile trigger not run yet
- **Fix**: Go back to "CRITICAL" section above and run the SQL

### Getting "Cannot POST /addresses/generate"?
- **Cause**: Old code still running
- **Fix**: Restart server: `cd server && npm run dev`

### Server says "Customer created" but then fails?
- **Cause**: Bitnob API might have changed address generation endpoint
- **Fix**: Check server logs for exact error message

## ğŸ“ What Happens Under the Hood

### Signup Flow:
1. User fills signup form â†’ Supabase Auth creates user
2. **Trigger fires** â†’ Profile created automatically in profiles table
3. Frontend calls `/api/wallet/create`
4. Backend calls Bitnob:
   - Creates customer in Bitnob
   - Generates Bitcoin address for customer
5. Backend updates profile with wallet info
6. User sees dashboard with Bitcoin address

### Login Flow:
1. User logs in â†’ Supabase Auth verifies credentials
2. Frontend checks if wallet exists
3. If no wallet â†’ automatically creates one (same as steps 3-5 above)
4. Dashboard loads with wallet info

### Address Generation:
- **Bitnob generates** the Bitcoin address (not your app)
- Each address is unique and secure
- Address belongs to your company's Bitnob wallet
- You can track which user owns which address
- Payments to that address â†’ your company wallet â†’ track by customer

## âœ… Success Criteria

You'll know everything is working when:

- [ ] No 422, 400, or 500 errors in browser console
- [ ] Server logs show "Customer created" and "Bitcoin address generated"
- [ ] Supabase profiles table has wallet_id and onchain_address
- [ ] Dashboard displays Bitcoin address
- [ ] New signups automatically get wallets
- [ ] Existing users logging in get wallets created

## ğŸš€ Next Steps After This Works

Once wallet creation is working:

1. Test creating an invoice
2. Test creating a payment link
3. Set up webhooks to detect payments
4. Test balance updates

## Need Help?

If you're still stuck after following this guide:

1. **Check server logs** - look for exact error messages
2. **Check browser console** - look for network errors
3. **Check Supabase logs** - Database â†’ Logs
4. **Share the error** - I can help debug further
